<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出席確認用QR作成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .input-group { margin: 15px auto; max-width: 400px; }
        input { width: 100%; padding: 10px; margin: 5px 0; font-size: 16px; box-sizing: border-box; border: 2px solid #ddd; border-radius: 4px; }
        input.error { border-color: #dc3545; }
        input.valid { border-color: #28a745; }
        .error-msg { color: #dc3545; font-size: 12px; margin: 5px 0; min-height: 18px; }
        .help-text { color: #666; font-size: 12px; margin: 5px 0; }
        button { padding: 12px 30px; background: #4285f4; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #qrcode { margin-top: 20px; display: flex; justify-content: center; }
    </style>
</head>
<body>
    <h2>出席確認用QR生成</h2>

    <div class="input-group">
        <input type="text" id="studentId" placeholder="学籍番号 (例: 2025001)" oninput="validateStudentId()">
        <div class="error-msg" id="idError"></div>
        <div class="help-text">※ 半角英数字のみ入力できます</div>
    </div>

    <div class="input-group">
        <input type="text" id="studentName" placeholder="氏名 (例: 山田太郎)" oninput="validateName()">
        <div class="error-msg" id="nameError"></div>
    </div>

    <button id="generateBtn" onclick="generateQR()">QRコードを作成</button>

    <div id="qrcode"></div>

    <script>
        const qrcode = new QRCode(document.getElementById("qrcode"), {
            width: 200,
            height: 200
        });

        let qrGenerated = false;

        function validateStudentId() {
            const input = document.getElementById("studentId");
            const errorMsg = document.getElementById("idError");
            const value = input.value.trim();

            // 半角英数字のみを許可（全角を自動変換）
            const alphanumericOnly = value.replace(/[^a-zA-Z0-9]/g, '');
            if (value !== alphanumericOnly) {
                input.value = alphanumericOnly;
            }

            if (alphanumericOnly === '') {
                input.className = '';
                errorMsg.textContent = '';
                updateButton();
                return false;
            }

            // 英数字チェック
            if (/^[a-zA-Z0-9]+$/.test(alphanumericOnly)) {
                input.className = 'valid';
                errorMsg.textContent = '';
                updateButton();
                return true;
            } else {
                input.className = 'error';
                errorMsg.textContent = '半角英数字のみ使用できます';
                updateButton();
                return false;
            }
        }

        function validateName() {
            const input = document.getElementById("studentName");
            const errorMsg = document.getElementById("nameError");
            const value = input.value.trim();

            if (value === '') {
                input.className = '';
                errorMsg.textContent = '';
                updateButton();
                return false;
            }

            // カンマは使用不可（CSVの区切り文字のため）
            if (value.includes(',')) {
                input.className = 'error';
                errorMsg.textContent = 'カンマ（,）は使用できません';
                updateButton();
                return false;
            }

            input.className = 'valid';
            errorMsg.textContent = '';
            updateButton();
            return true;
        }

        function updateButton() {
            const btn = document.getElementById("generateBtn");
            const id = document.getElementById("studentId").value.trim();
            const name = document.getElementById("studentName").value.trim();
            const idValid = /^[a-zA-Z0-9]+$/.test(id);
            const nameValid = name !== '' && !name.includes(',');

            btn.disabled = !(idValid && nameValid);
        }

        function generateQR() {
            const id = document.getElementById("studentId").value.trim();
            const name = document.getElementById("studentName").value.trim();

            // 最終バリデーション
            if (!id || !name) {
                alert("学籍番号と氏名を入力してください");
                return;
            }

            if (!/^[a-zA-Z0-9]+$/.test(id)) {
                alert("学籍番号は半角英数字のみで入力してください");
                return;
            }

            if (name.includes(',')) {
                alert("氏名にカンマ（,）は使用できません");
                return;
            }

            // QRコードを作成（既存のQRコードをクリア）
            if (qrGenerated) {
                document.getElementById("qrcode").innerHTML = '';
                const newQrcode = new QRCode(document.getElementById("qrcode"), {
                    width: 200,
                    height: 200,
                    text: `${id},${name}`
                });
            } else {
                qrcode.makeCode(`${id},${name}`);
                qrGenerated = true;
            }
        }

        // 初期状態でボタンを無効化
        updateButton();
    </script>
</body>
</html>