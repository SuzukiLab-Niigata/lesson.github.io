<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºå¸­ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .config { max-width: 700px; margin: 20px auto; padding: 20px; background: #f5f5f5; border-radius: 8px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        table { width: 95%; max-width: 800px; margin: 20px auto; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #4285f4; color: white; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #4285f4; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        #video { width: 100%; max-width: 400px; margin: 10px auto; border: 2px solid #ddd; border-radius: 8px; }
        #shareUrl { width: 100%; padding: 8px; margin: 10px 0; font-size: 12px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; }
        .hidden { display: none; }
        .user-info { margin: 10px 0; padding: 10px; background: white; border-radius: 5px; }
    </style>
</head>
<body>
    <h2>ğŸ“‹ å‡ºå¸­ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>

    <div class="config">
        <h3>Google Spreadsheeté€£æº</h3>
        <div id="loginSection">
            <p>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€å‡ºå¸­è¨˜éŒ²ç”¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆã—ã¾ã™</p>
            <p style="font-size: 12px; color: #666;">
                âš ï¸ æ³¨æ„: ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Google Cloud Consoleã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€<br>
                APIã‚­ãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
                è©³ç´°ã¯READMEã‚’ã”è¦§ãã ã•ã„ã€‚
            </p>
            <input type="text" id="apiKey" placeholder="Google API Key" style="width: 100%; padding: 8px; margin: 5px 0;">
            <input type="text" id="clientId" placeholder="Google Client ID" style="width: 100%; padding: 8px; margin: 5px 0;">
            <button class="btn-primary" onclick="saveCredentials()">èªè¨¼æƒ…å ±ã‚’ä¿å­˜ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <div id="userSection" class="hidden">
            <div class="user-info">
                <strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­:</strong> <span id="userName"></span>
                <button class="btn-secondary" onclick="signOut()" style="margin-left: 10px; padding: 5px 10px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <div id="status" class="status info">æº–å‚™ä¸­...</div>
            <div id="spreadsheetInfo" class="hidden">
                <p><strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ:</strong> <a id="spreadsheetLink" href="" target="_blank">é–‹ã</a></p>
                <p style="font-size: 12px;">ã“ã®URLã‚’å…±æœ‰ã™ã‚‹ã¨ã€ä»–ã®äººã‚‚åŒã˜ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã§ãã¾ã™ï¼š</p>
                <input type="text" id="shareUrl" readonly onclick="this.select()">
                <button class="btn-secondary" onclick="copyShareUrl()">URLã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
    </div>

    <div id="scannerSection" class="hidden">
        <video id="video" playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>

        <div>
            <button class="btn-success" onclick="downloadCSV()">CSVã§ä¿å­˜</button>
            <button class="btn-danger" onclick="clearData()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>

        <table id="list">
            <thead><tr><th>å­¦ç±ç•ªå·</th><th>æ°å</th><th>æ—¥ä»˜</th><th>æ™‚åˆ»</th><th>çŠ¶æ…‹</th></tr></thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>

    <script>
        // è¨­å®š
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let spreadsheetId = null;

        const attendanceData = [];
        const attendanceSet = new Set();

        // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³é–¢é€£
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const listBody = document.getElementById("listBody");

        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const sheetIdFromUrl = urlParams.get('sheetId');
            if (sheetIdFromUrl) {
                spreadsheetId = sheetIdFromUrl;
                localStorage.setItem('spreadsheetId', spreadsheetId);
            } else {
                spreadsheetId = localStorage.getItem('spreadsheetId');
            }

            // ä¿å­˜ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            const savedApiKey = localStorage.getItem('googleApiKey');
            const savedClientId = localStorage.getItem('googleClientId');
            if (savedApiKey && savedClientId) {
                document.getElementById('apiKey').value = savedApiKey;
                document.getElementById('clientId').value = savedClientId;
            }
        });

        // GAPIåˆæœŸåŒ–
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            const apiKey = localStorage.getItem('googleApiKey');
            if (!apiKey) return;

            await gapi.client.init({
                apiKey: apiKey,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // GISåˆæœŸåŒ–
        function gisLoaded() {
            const clientId = localStorage.getItem('googleClientId');
            if (!clientId) return;

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: '', // å¾Œã§è¨­å®š
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                console.log('Google APIæº–å‚™å®Œäº†');
            }
        }

        // èªè¨¼æƒ…å ±ã‚’ä¿å­˜ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
        function saveCredentials() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const clientId = document.getElementById('clientId').value.trim();

            if (!apiKey || !clientId) {
                alert('API Keyã¨Client IDã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            localStorage.setItem('googleApiKey', apiKey);
            localStorage.setItem('googleClientId', clientId);

            // åˆæœŸåŒ–ã‚’å†å®Ÿè¡Œ
            gapiLoaded();
            gisLoaded();

            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¤ãƒ³
            setTimeout(handleAuthClick, 500);
        }

        // ã‚µã‚¤ãƒ³ã‚¤ãƒ³
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = gapi.client.getToken().access_token;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('userSection').classList.remove('hidden');
                document.getElementById('scannerSection').classList.remove('hidden');

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                const userInfo = await getUserInfo();
                document.getElementById('userName').textContent = userInfo.name;

                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã¾ãŸã¯å–å¾—
                await setupSpreadsheet();

                // ã‚«ãƒ¡ãƒ©èµ·å‹•
                startCamera();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
        async function getUserInfo() {
            const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            return await response.json();
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š
        async function setupSpreadsheet() {
            if (spreadsheetId) {
                // æ—¢å­˜ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨
                updateStatus('æ—¢å­˜ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¥ç¶šã—ã¾ã—ãŸ', 'connected');
                updateSpreadsheetInfo();
            } else {
                // æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
                await createSpreadsheet();
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
        async function createSpreadsheet() {
            updateStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...', 'info');

            try {
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: `å‡ºå¸­è¨˜éŒ²_${new Date().toLocaleDateString()}`
                    },
                    sheets: [{
                        properties: {
                            title: 'å‡ºå¸­ãƒ‡ãƒ¼ã‚¿',
                            gridProperties: {
                                frozenRowCount: 1
                            }
                        }
                    }]
                });

                spreadsheetId = response.result.spreadsheetId;
                localStorage.setItem('spreadsheetId', spreadsheetId);

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¿½åŠ 
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'å‡ºå¸­ãƒ‡ãƒ¼ã‚¿!A1:E1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['å­¦ç±ç•ªå·', 'æ°å', 'æ—¥ä»˜', 'æ™‚åˆ»', 'è¨˜éŒ²æ—¥æ™‚']]
                    }
                });

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        requests: [{
                            repeatCell: {
                                range: {
                                    sheetId: 0,
                                    startRowIndex: 0,
                                    endRowIndex: 1
                                },
                                cell: {
                                    userEnteredFormat: {
                                        backgroundColor: { red: 0.26, green: 0.52, blue: 0.96 },
                                        textFormat: { foregroundColor: { red: 1, green: 1, blue: 1 }, bold: true }
                                    }
                                },
                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                            }
                        }]
                    }
                });

                updateStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼', 'connected');
                updateSpreadsheetInfo();
                updateShareUrl();

            } catch (error) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'disconnected');
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’æ›´æ–°
        function updateSpreadsheetInfo() {
            const link = document.getElementById('spreadsheetLink');
            link.href = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
            document.getElementById('spreadsheetInfo').classList.remove('hidden');
            updateShareUrl();
        }

        // å…±æœ‰URLæ›´æ–°
        function updateShareUrl() {
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?sheetId=${spreadsheetId}`;
            document.getElementById('shareUrl').value = shareUrl;
        }

        // URL ã‚’ã‚³ãƒ”ãƒ¼
        function copyShareUrl() {
            const input = document.getElementById('shareUrl');
            input.select();
            document.execCommand('copy');
            alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ã“ã®URLã‚’ä»–ã®äººã¨å…±æœ‰ã—ã¦ãã ã•ã„ã€‚');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
        function signOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('scannerSection').classList.add('hidden');

            // ã‚«ãƒ¡ãƒ©åœæ­¢
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true);
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(err => {
                    console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
                    alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        }

        // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    processData(code.data);
                }
            }
            requestAnimationFrame(tick);
        }

        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
        async function processData(data) {
            if (attendanceSet.has(data)) return;

            attendanceSet.add(data);
            const [id, name] = data.split(",");
            const now = new Date();
            const date = now.toLocaleDateString('ja-JP');
            const time = now.toLocaleTimeString('ja-JP');
            const timestamp = now.toISOString();

            const record = { id, name, date, time, timestamp };
            attendanceData.push(record);

            // ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
            const row = document.createElement('tr');
            row.innerHTML = `<td>${id}</td><td>${name}</td><td>${date}</td><td>${time}</td><td id="status-${id}">é€ä¿¡ä¸­...</td>`;
            listBody.insertBefore(row, listBody.firstChild);

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            document.body.style.backgroundColor = "#e0ffe0";
            setTimeout(() => document.body.style.backgroundColor = "white", 300);

            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡
            await sendToSpreadsheet(record, id);
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡
        async function sendToSpreadsheet(record, id) {
            if (!spreadsheetId) {
                updateStatusCell(id, 'æœªè¨­å®š');
                return;
            }

            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: spreadsheetId,
                    range: 'å‡ºå¸­ãƒ‡ãƒ¼ã‚¿!A:E',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [[record.id, record.name, record.date, record.time, record.timestamp]]
                    }
                });

                updateStatusCell(id, 'âœ“');
            } catch (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                updateStatusCell(id, 'âœ—');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ«æ›´æ–°
        function updateStatusCell(id, status) {
            const cell = document.getElementById(`status-${id}`);
            if (cell) {
                cell.textContent = status;
                if (status === 'âœ“') {
                    cell.style.color = 'green';
                    cell.style.fontWeight = 'bold';
                } else if (status === 'âœ—') {
                    cell.style.color = 'red';
                    cell.style.fontWeight = 'bold';
                }
            }
        }

        // CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV() {
            let csv = "å­¦ç±ç•ªå·,æ°å,æ—¥ä»˜,æ™‚åˆ»\n";
            attendanceData.forEach(record => {
                csv += `${record.id},${record.name},${record.date},${record.time}\n`;
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `attendance_${new Date().toLocaleDateString('ja-JP').replace(/\//g, '-')}.csv`;
            link.click();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearData() {
            if (confirm('ãƒ­ãƒ¼ã‚«ãƒ«ã®å‡ºå¸­ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰')) {
                attendanceData.length = 0;
                attendanceSet.clear();
                listBody.innerHTML = '';
            }
        }

        // APIèª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        setTimeout(() => {
            if (typeof gapi !== 'undefined') gapiLoaded();
            if (typeof google !== 'undefined') gisLoaded();
        }, 1000);
    </script>
</body>
</html>
